<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Drug Matching Activity</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea, #764ba2);
  min-height: 100vh;
  padding-bottom: 50px;
}

.container {
  max-width: 900px;
  margin: 15px auto;
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

h2, h3 {
  text-align: center;
  color: #333;
  margin: 10px 0;
}

h2 {
  font-size: 24px;
  color: #667eea;
}

h3 {
  font-size: 18px;
  color: #666;
  font-weight: 500;
}

.hidden {
  display: none;
}

input, button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  margin-top: 10px;
}

input {
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  transition: border-color 0.3s;
}

input:focus {
  outline: none;
  border-color: #667eea;
}

button {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  touch-action: manipulation;
}

button:active {
  transform: translateY(1px);
}

.timer {
  text-align: center;
  font-weight: bold;
  margin-bottom: 20px;
  font-size: 20px;
  color: #667eea;
  background: #f0f4ff;
  padding: 12px;
  border-radius: 8px;
}

.match-row {
  display: flex;
  flex-wrap: wrap;
  margin-bottom: 15px;
  align-items: stretch;
  background: #fafafa;
  border-radius: 10px;
  padding: 10px;
  gap: 10px;
}

.title {
  flex: 1 1 55%;
  padding: 10px;
  font-size: 15px;
  color: #333;
  display: flex;
  align-items: center;
  font-weight: 500;
}

.dropzone {
  flex: 1 1 40%;
  min-height: 60px;
  border: 2px dashed #ccc;
  border-radius: 10px;
  padding: 8px;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.dropzone.drag-over {
  background: #e8f0ff;
  border-color: #667eea;
  border-style: solid;
  transform: scale(1.02);
}

.pool {
  background: linear-gradient(135deg, #f5f7fa, #e8eef5);
  border-radius: 12px;
  padding: 15px;
  margin-top: 20px;
  border: 2px solid #e0e0e0;
}

.draggable {
  background: linear-gradient(135deg, #ffd166, #ffb347);
  padding: 14px;
  margin: 8px 0;
  border-radius: 10px;
  font-weight: 600;
  text-align: center;
  cursor: move;
  user-select: none;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  color: #333;
  position: relative;
}

.draggable:active {
  cursor: grabbing;
}

.dragging-clone {
  position: fixed;
  background: linear-gradient(135deg, #ffd166, #ffb347);
  padding: 14px;
  border-radius: 10px;
  font-weight: 600;
  text-align: center;
  color: #333;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  pointer-events: none;
  z-index: 9999;
  opacity: 0.9;
  transform: scale(1.05);
}

.draggable.being-dragged {
  opacity: 0.3;
}

.result {
  text-align: center;
  font-weight: bold;
  margin-top: 20px;
  font-size: 18px;
  color: #333;
  padding: 15px;
  border-radius: 8px;
  background: #f0f4ff;
}

@media (max-width: 600px) {
  .match-row {
    flex-direction: column;
  }
  
  .title, .dropzone {
    flex: 1 1 100%;
  }
  
  .container {
    padding: 15px;
    margin: 10px;
  }
}
</style>
</head>

<body>

<div class="container">

<!-- NAME SCREEN -->
<div id="nameScreen">
  <h2>Enter Your Name</h2>
  <input id="traineeName" placeholder="Your name">
  <button onclick="startGame()">Start</button>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="hidden">
  <div class="timer">Time: <span id="time">0</span> sec</div>

  <div id="matches"></div>

  <h3>Tap and drag the drugs into the correct boxes</h3>
  <div class="pool" id="pool"></div>

  <button onclick="submitAnswers()">Submit</button>
  <div class="result" id="result"></div>
</div>

</div>

<script>
// ---------------- DATA ----------------
const correct = {
  d1: "Vominore | Meclizine, pyridoxine",
  d2: "Bio-fiber",
  d3: "Duphalac",
  d4: "Resolor",
  d5: "Laxatrol | docusate, senna",
  d6: "Kapect"
};

const titles = [
  "Reduce nausea & vomiting during pregnancy",
  "Bulk forming laxative",
  "Safe laxative for elderly",
  "Used for chronic constipation",
  "Frequent use can cause cathartic colon",
  "Adsorb toxins & reduce fecal passage frequencies"
];

// ---------------- STATE ----------------
let timer = 0;
let interval;
let traineeName = "";

// Drag state
let draggedElement = null;
let dragClone = null;
let currentDropZone = null;
let touchOffsetX = 0;
let touchOffsetY = 0;
let autoScrollInterval = null;

// ---------------- START ----------------
function startGame() {
  traineeName = document.getElementById("traineeName").value.trim();
  if (!traineeName) {
    alert("Please enter your name");
    return;
  }

  document.getElementById("nameScreen").classList.add("hidden");
  document.getElementById("gameScreen").classList.remove("hidden");

  interval = setInterval(() => {
    timer++;
    document.getElementById("time").innerText = timer;
  }, 1000);

  loadGame();
}

// ---------------- LOAD GAME ----------------
function loadGame() {
  const matches = document.getElementById("matches");
  const pool = document.getElementById("pool");
  matches.innerHTML = "";
  pool.innerHTML = "";

  // Create drop zones
  titles.forEach((title, i) => {
    const row = document.createElement("div");
    row.className = "match-row";
    row.innerHTML = `
      <div class="title">${title}</div>
      <div class="dropzone" data-id="d${i + 1}"></div>
    `;
    matches.appendChild(row);
  });

  // Create draggable cards (shuffled)
  shuffle(Object.entries(correct)).forEach(([id, text]) => {
    const div = document.createElement("div");
    div.className = "draggable";
    div.id = id;
    div.dataset.value = text;
    div.textContent = text;
    pool.appendChild(div);
    
    // Add event listeners
    setupDragElement(div);
  });
}

// ---------------- DRAG SETUP ----------------
function setupDragElement(element) {
  // Touch events
  element.addEventListener('touchstart', handleDragStart, { passive: false });
  
  // Mouse events
  element.addEventListener('mousedown', handleDragStart);
}

// ---------------- DRAG START ----------------
function handleDragStart(e) {
  // Prevent default to avoid text selection and scrolling
  if (e.type === 'touchstart') {
    e.preventDefault();
  }
  
  draggedElement = e.currentTarget;
  
  // Get touch or mouse position
  const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
  const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  
  // Calculate offset from element position
  const rect = draggedElement.getBoundingClientRect();
  touchOffsetX = clientX - rect.left;
  touchOffsetY = clientY - rect.top;
  
  // Create visual clone
  dragClone = document.createElement('div');
  dragClone.className = 'dragging-clone';
  dragClone.textContent = draggedElement.textContent;
  dragClone.style.width = rect.width + 'px';
  dragClone.style.left = (clientX - touchOffsetX) + 'px';
  dragClone.style.top = (clientY - touchOffsetY) + 'px';
  document.body.appendChild(dragClone);
  
  // Make original semi-transparent
  draggedElement.classList.add('being-dragged');
  
  // Add move and end listeners
  if (e.type === 'touchstart') {
    document.addEventListener('touchmove', handleDragMove, { passive: false });
    document.addEventListener('touchend', handleDragEnd);
    document.addEventListener('touchcancel', handleDragEnd);
  } else {
    document.addEventListener('mousemove', handleDragMove);
    document.addEventListener('mouseup', handleDragEnd);
  }
  
  // Start auto-scroll check
  startAutoScroll();
}

// ---------------- DRAG MOVE ----------------
function handleDragMove(e) {
  if (!dragClone || !draggedElement) return;
  
  e.preventDefault();
  
  const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
  const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
  
  // Update clone position
  dragClone.style.left = (clientX - touchOffsetX) + 'px';
  dragClone.style.top = (clientY - touchOffsetY) + 'px';
  
  // Find drop zone under touch/mouse
  const elementBelow = document.elementFromPoint(clientX, clientY);
  const dropZone = elementBelow?.closest('.dropzone');
  
  // Update drop zone highlighting
  if (dropZone !== currentDropZone) {
    if (currentDropZone) {
      currentDropZone.classList.remove('drag-over');
    }
    if (dropZone) {
      dropZone.classList.add('drag-over');
    }
    currentDropZone = dropZone;
  }
}

// ---------------- DRAG END ----------------
function handleDragEnd(e) {
  if (!dragClone || !draggedElement) return;
  
  const clientX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
  const clientY = e.type === 'touchend' ? e.changedTouches[0].clientY : e.clientY;
  
  // Find drop target
  const elementBelow = document.elementFromPoint(clientX, clientY);
  const dropZone = elementBelow?.closest('.dropzone');
  
  // Handle drop
  if (dropZone) {
    // Check if zone already has an item
    const existingItem = dropZone.querySelector('.draggable');
    
    if (existingItem && existingItem !== draggedElement) {
      // Swap: move existing item back to pool
      document.getElementById('pool').appendChild(existingItem);
    }
    
    // Move dragged element to drop zone
    dropZone.appendChild(draggedElement);
  }
  
  // Cleanup
  draggedElement.classList.remove('being-dragged');
  document.body.removeChild(dragClone);
  
  if (currentDropZone) {
    currentDropZone.classList.remove('drag-over');
  }
  
  dragClone = null;
  draggedElement = null;
  currentDropZone = null;
  
  // Remove listeners
  document.removeEventListener('touchmove', handleDragMove);
  document.removeEventListener('touchend', handleDragEnd);
  document.removeEventListener('touchcancel', handleDragEnd);
  document.removeEventListener('mousemove', handleDragMove);
  document.removeEventListener('mouseup', handleDragEnd);
  
  // Stop auto-scroll
  stopAutoScroll();
}

// ---------------- AUTO SCROLL ----------------
function startAutoScroll() {
  if (autoScrollInterval) return;
  
  autoScrollInterval = setInterval(() => {
    if (!dragClone) {
      stopAutoScroll();
      return;
    }
    
    const rect = dragClone.getBoundingClientRect();
    const scrollThreshold = 100;
    const scrollSpeed = 10;
    
    // Scroll up if near top
    if (rect.top < scrollThreshold) {
      window.scrollBy(0, -scrollSpeed);
    }
    
    // Scroll down if near bottom
    if (rect.bottom > window.innerHeight - scrollThreshold) {
      window.scrollBy(0, scrollSpeed);
    }
  }, 16); // ~60fps
}

function stopAutoScroll() {
  if (autoScrollInterval) {
    clearInterval(autoScrollInterval);
    autoScrollInterval = null;
  }
}

// ---------------- SUBMIT ----------------
function submitAnswers() {
  const zones = document.querySelectorAll(".dropzone");
  const result = document.getElementById("result");

  if (zones.length !== 6) {
    result.innerText = "Internal error. Reload the page.";
    return;
  }

  for (let zone of zones) {
    if (!zone.firstElementChild) {
      result.innerText = "âš ï¸ Please complete all matches before submitting.";
      result.style.background = '#fff3cd';
      result.style.color = '#856404';
      return;
    }
  }

  let score = 0;

  for (let zone of zones) {
    const expected = correct[zone.dataset.id];
    const placedEl = zone.firstElementChild;

    if (!placedEl || !placedEl.dataset) continue;

    if (placedEl.dataset.value === expected) {
      score++;
    }
  }

  if (score !== 6) {
    result.innerText = `You answered ${score} out of 6 correct. Try again! ðŸ’ª`;
    result.style.background = '#ffe8e8';
    result.style.color = '#d32f2f';
    return;
  }

  clearInterval(interval);
  result.style.background = '#e8f5e9';
  result.style.color = '#2e7d32';
  saveResult();
}

// ---------------- SAVE ----------------
function saveResult() {
  fetch("https://script.google.com/macros/s/AKfycbywTBmYCeVtyqTU_Xqr1CDEFdo5Cj-9ianBNZdWT1avaMQUYHVof_dG2r29utcqivZHSw/exec", {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      name: traineeName,
      time: timer + " sec"
    })
  });

  document.getElementById("result").innerText =
    "ðŸŽ‰ All answers correct! Your result has been saved.";
}

// ---------------- UTILS ----------------
function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}
</script>

</body>
</html>
